<!doctype html>
<html lang="hr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Knjižnica – Admin</title>

<style>
body{
  margin:0;
  background:#0b0f1a;
  color:#e5e7eb;
  font-family:system-ui, sans-serif;
}
.wrap{
  max-width:1100px;
  margin:0 auto;
  padding:16px;
}

/* CARD */
.card{
  background:#111827;
  border:1px solid #1f2937;
  padding:16px;
  border-radius:12px;
  margin-bottom:18px;
}
.card h2{
  margin:0 0 10px;
  font-size:18px;
}

/* INPUTS */
.field{margin-bottom:10px;display:flex;flex-direction:column;}
.field label{font-size:13px;margin-bottom:3px;color:#93a3b8;}
.field input, .field select{
  padding:8px;
  border-radius:8px;
  border:1px solid #1f2937;
  background:#0f172a;
  color:#e5e7eb;
}
.field input:focus, .field select:focus{
  outline:none;
  border-color:#22c55e;
}

/* BUTTONS */
.btn{
  padding:7px 14px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  background:#22c55e;
  color:#032f18;
  font-weight:600;
}
.btn:hover{background:#4ade80;}
.btn-danger{background:#ef4444;color:#fee2e2;}
.btn-danger:hover{background:#f87171;}
.btn-ghost{
  background:transparent;
  border:1px solid #334155;
  color:#93a3b8;
}
.btn-ghost:hover{border-color:#22c55e;color:#22c55e;}

/* STATUS */
.status{
  margin-top:6px;
  font-size:13px;
}
.status.ok{color:#22c55e;}
.status.err{color:#ef4444;}

/* TABLE */
table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}
th,td{
  padding:8px;
  border-bottom:1px solid #1f2937;
}
th{color:#93a3b8;text-align:left;background:#0f172a;position:sticky;top:0;}
tr:nth-child(even) td{background:#1e293b;}
</style>
</head>
<body>
<div class="wrap">

<!-- ADMIN INFO -->
<div id="adminBox" class="card">
  Učitavam korisnika...
</div>

<!-- BOOK FORM -->
<div class="card">
  <h2>Knjiga</h2>

  <div class="field">
    <label>ID</label>
    <input id="bookId" readonly>
  </div>

  <div class="field">
    <label>Naslov *</label>
    <input id="bookName">
  </div>

  <div class="field">
    <label>Pisac *</label>
    <input id="bookAuthor">
  </div>

  <div class="field">
    <label>Slika (samo ime: knjiga1.jpg) *</label>
    <input id="bookImage" placeholder="knjiga1.jpg">
  </div>

  <div class="field">
    <label>Razred *</label>
    <select id="bookGrade">
      <option value="">-- odaberi --</option>

      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
      <option value="6">6</option>
      <option value="7">7</option>
      <option value="8">8</option>
      <option value="9">9</option>

      <option value="1s">1. srednja</option>
      <option value="2s">2. srednja</option>
      <option value="3s">3. srednja</option>
      <option value="4s">4. srednja</option>

      <option value="knjige">knjige</option>
    </select>
  </div>

  <div class="field">
    <label>Cijena (silver) *</label>
    <input type="number" id="bookPrice" value="0">
  </div>

  <div class="field">
    <label>PDF putanja *</label>
    <input id="bookPdf" placeholder="/pdf/1/ime.pdf">
  </div>

  <button class="btn" onclick="saveBook()">Spremi</button>
  <button class="btn-ghost" onclick="clearForm()">Nova knjiga</button>
  <div id="formStatus" class="status"></div>
</div>

<!-- GOLD PANEL -->
<div class="card">
  <h2>Dodaj GOLD korisniku</h2>

  <div class="field">
    <label>Email korisnika *</label>
    <input id="goldEmail">
  </div>

  <div class="field">
    <label>Količina gold *</label>
    <input id="goldAmount" type="number" value="0">
  </div>

  <button class="btn" onclick="addGold()">Dodaj gold</button>
  <div id="goldStatus" class="status"></div>
</div>

<!-- TABLE -->
<div class="card">
  <h2>Popis knjiga</h2>
  <div id="listStatus" class="status"></div>
  <div id="booksList"></div>
</div>

</div>

<script>
let books = [];

/* ============================================================
   ADMIN KEY LOGIN
============================================================ */
async function adminKeyLogin() {
  const key = prompt("Unesi ADMIN KEY:");

  if (!key) return alert("Prazan ključ.");

  localStorage.setItem("ADMIN_KEY", key);

  const test = await fetch("/api/admin/books", {
    headers: { "x-admin-key": key }
  });

  const j = await test.json();

  if (!j.ok) {
    alert("Pogrešan ključ!");
    localStorage.removeItem("ADMIN_KEY");
    return;
  }

  adminBox.innerHTML =
    `Prijavljen preko <b>ADMIN_KEY</b><br>
     <button class='btn-ghost' onclick="logoutKey()">Odjava</button>`;

  loadBooks();
}

function logoutKey(){
  localStorage.removeItem("ADMIN_KEY");
  location.reload();
}

function adminHeaders(extra = {}) {
  const key = localStorage.getItem("ADMIN_KEY");
  if (key) return { ...extra, "x-admin-key": key };
  return extra;
}

/* ============================================================
   USER / AUTH LOGIN
============================================================ */
async function loadUser(){
  const box=document.getElementById("adminBox");

  // ako postoji admin key → preskoči normalni login
  if (localStorage.getItem("ADMIN_KEY")) {
    box.innerHTML =
      `Prijavljen preko <b>ADMIN_KEY</b><br>
       <button class='btn-ghost' onclick="logoutKey()">Odjava</button>`;
    loadBooks();
    return;
  }

  try{
    const r=await fetch("/api/me");
    const d=await r.json();

    if(!d.ok || !d.user.is_admin){
      box.innerHTML = `
        Nemaš pristup adminu.<br><br>
        <button class='btn' onclick='adminKeyLogin()'>Login preko KEY-a</button>
      `;
      return;
    }

    box.innerHTML=`Prijavljen kao <b>${d.user.email}</b> (admin)
      <br><button class='btn-ghost' onclick="logout()">Odjava</button>`;

  }catch{
    box.innerHTML="Greška.";
  }
}

function logout(){
  localStorage.removeItem("ADMIN_KEY");
  fetch("/api/logout").then(()=>location.reload());
}

/* ============================================================
   CLEAR FORM
============================================================ */
function clearForm(){
  bookId.value="";
  bookName.value="";
  bookAuthor.value="";
  bookImage.value="";
  bookGrade.value="";
  bookPrice.value="0";
  bookPdf.value="";
  formStatus.textContent="";
}

/* ============================================================
   LOAD BOOKS
============================================================ */
async function loadBooks(){
  listStatus.textContent="Učitavam...";

  try{
    const r=await fetch("/api/admin/books",{
      headers: adminHeaders()
    });

    const d=await r.json();

    if(!d.ok){
      listStatus.textContent=d.error;
      return;
    }

    books=d.books;
    listStatus.textContent="Učitano: "+books.length;
    renderTable();

  }catch{
    listStatus.textContent="Greška.";
  }
}

/* ============================================================
   RENDER TABLE
============================================================ */
function renderTable(){
  if(books.length===0){
    booksList.innerHTML="Nema knjiga.";
    return;
  }

  let html=`
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Naslov</th>
        <th>Pisac</th>
        <th>Slika</th>
        <th>Raz.</th>
        <th>Cijena</th>
        <th>PDF</th>
        <th>Akcije</th>
      </tr>
    </thead>
    <tbody>`;

  books.forEach(b=>{
    html+=`
      <tr>
        <td>${b.id}</td>
        <td>${b.name}</td>
        <td>${b.author}</td>
        <td>${b.cover_image}</td>
        <td>${b.grade}</td>
        <td>${b.price_silver}</td>
        <td>${b.pdf_path}</td>
        <td>
          <button class="btn-ghost" onclick="editBook(${b.id})">Uredi</button>
          <button class="btn-danger" onclick="deleteBook(${b.id})">Obriši</button>
        </td>
      </tr>`;
  });

  html+=`</tbody></table>`;
  booksList.innerHTML=html;
}

/* ============================================================
   EDIT BOOK
============================================================ */
function editBook(id){
  const b=books.find(x=>x.id===id);
  if(!b) return;

  bookId.value=b.id;
  bookName.value=b.name;
  bookAuthor.value=b.author;
  bookImage.value=b.cover_image.replace("/slike/","");
  bookGrade.value=b.grade;
  bookPrice.value=b.price_silver;
  bookPdf.value=b.pdf_path;
}

/* ============================================================
   SAVE BOOK
============================================================ */
async function saveBook(){
  formStatus.textContent="";

  const filename = bookImage.value.trim();

  const payload={
    id: bookId.value || null,
    name: bookName.value.trim(),
    author: bookAuthor.value.trim(),
    cover_image: "/slike/" + filename,
    grade: bookGrade.value.trim(),
    price_silver: Number(bookPrice.value),
    pdf_path: bookPdf.value.trim()
  };

  if(!payload.name || !payload.author || !filename || !payload.grade || !payload.pdf_path){
    formStatus.textContent="Popuni sva polja.";
    formStatus.className="status err";
    return;
  }

  const r=await fetch("/api/admin/books/save",{
    method:"POST",
    headers: adminHeaders({"Content-Type":"application/json"}),
    body:JSON.stringify(payload)
  });

  const d=await r.json();

  if(!d.ok){
    formStatus.textContent=d.error || "Greška.";
    formStatus.className="status err";
    return;
  }

  formStatus.textContent="Spremljeno!";
  formStatus.className="status ok";

  await loadBooks();
  if(!payload.id) clearForm();
}

/* ============================================================
   DELETE BOOK
============================================================ */
async function deleteBook(id){
  const r=await fetch("/api/admin/books/delete",{
    method:"POST",
    headers: adminHeaders({"Content-Type":"application/json"}),
    body:JSON.stringify({id})
  });

  const d=await r.json();

  if(!d.ok){
    listStatus.textContent=d.error;
    listStatus.className="status err";
    return;
  }

  listStatus.textContent="Knjiga obrisana.";
  listStatus.className="status ok";
  loadBooks();
}

/* ============================================================
   ADD GOLD
============================================================ */
async function addGold(){
  goldStatus.textContent="";

  const email = goldEmail.value.trim();
  const amount = Number(goldAmount.value.trim());

  const r=await fetch("/api/admin/add-gold",{
    method:"POST",
    headers: adminHeaders({"Content-Type":"application/json"}),
    body:JSON.stringify({ email, gold:amount })
  });

  const d=await r.json();

  if(!d.ok){
    goldStatus.textContent=d.error;
    goldStatus.className="status err";
    return;
  }

  goldStatus.textContent="Gold dodan!";
  goldStatus.className="status ok";
}

/* START */
loadUser();
loadBooks();
</script>

</body>
</html>
