<!doctype html>
<html lang="hr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Online Knjižnica</title>

  <style>
    :root{
      --bg:#020617;
      --bg2:#02081f;
      --card:#02081f;
      --accent:#22c55e;
      --accent-soft:rgba(34,197,94,0.15);
      --danger:#ef4444;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border:#1f2937;
    }
    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,sans-serif;
      background:radial-gradient(circle at top,#0b1120 0,#020617 55%,#000 100%);
      color:var(--text);
    }

    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 14px;
      background:linear-gradient(135deg,#020617,#02081f);
      border:1px solid var(--border);
      border-radius:14px;
      box-shadow:0 18px 45px rgba(0,0,0,0.7);
      position:sticky;
      top:0;
      z-index:10;
      gap:12px;
    }

    .logo-title h1{
      margin:0;
      font-size:18px;
      text-transform:uppercase;
    }
    .logo-title span{
      font-size:11px;
      color:var(--muted);
    }

    .btn{
      padding:6px 12px;
      border-radius:999px;
      border:none;
      background:var(--accent);
      color:#022c22;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
    }

    .btn-ghost{
      padding:5px 11px;
      border-radius:999px;
      background:transparent;
      border:1px solid var(--border);
      color:var(--muted);
      font-size:11px;
      cursor:pointer;
    }

    .pill{
      padding:6px 10px;
      border-radius:999px;
      font-size:11px;
      background:rgba(15,23,42,0.9);
      border:1px solid var(--border);
      color:var(--muted);
      display:flex;
      gap:6px;
    }

    .layout{
      display:grid;
      grid-template-columns:260px minmax(0,1fr);
      gap:14px;
    }

    @media(max-width:800px){
      .layout{ grid-template-columns:1fr; }
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      padding:14px;
      border-radius:14px;
      box-shadow:0 18px 40px rgba(0,0,0,0.75);
    }

    /* knjige grid */
    .books-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
      gap:12px;
    }
    .book-card{
      display:flex;
      gap:10px;
      background:radial-gradient(circle at top,#02081f 0,#020617 65%);
      border:1px solid #111827;
      border-radius:12px;
      padding:10px;
      position:relative;
      min-height:110px;
    }

    /* ✔ nova slika */
    .book-img{
      width:80px;
      height:110px;
      background:#111827;
      background-size:cover;
      background-position:center;
      border-radius:6px;
      flex-shrink:0;
    }

    .book-title{ font-size:13px; font-weight:600; }
    .book-author{ font-size:11px; color:var(--muted); }

    .price-tag{
      padding:3px 7px;
      border-radius:999px;
      background:#111827;
      border:1px solid #1f2937;
      font-size:11px;
    }
    .price-free{
      background:var(--accent-soft);
      border-color:var(--accent);
      color:var(--accent);
    }

    .book-actions{
      margin-top:6px;
      display:flex;
      gap:6px;
    }

    .btn-small{
      padding:4px 8px;
      border-radius:999px;
      font-size:11px;
      border:none;
      cursor:pointer;
    }
    .btn-outline{
      border:1px solid var(--border);
      background:transparent;
      color:var(--muted);
    }

    .badge-owned{
      position:absolute;
      top:6px;
      right:8px;
      background:rgba(34,197,94,0.18);
      color:var(--accent);
      padding:2px 6px;
      border-radius:999px;
      font-size:10px;
      border:1px solid rgba(34,197,94,0.3);
    }
  </style>
</head>

<body>
<div class="wrap">

<header>
  <div class="logo-title">
    <h1>Online Knjižnica</h1>
    <span>PDF knjige • škole</span>
  </div>

  <div class="user-box" id="userBox"></div>
</header>

<main>
  <div class="layout">

    <!-- AUTH -->
    <section>
      <div class="card" id="authCard">
        <div style="display:flex;gap:6px;margin-bottom:10px;">
          <button class="btn-ghost" style="flex:1" data-tab="login">Prijava</button>
          <button class="btn-ghost" style="flex:1" data-tab="register">Registracija</button>
        </div>

        <!-- LOGIN -->
        <form id="loginForm">
          <input id="loginEmail" placeholder="Email" required style="width:100%;margin-bottom:6px;">
          <input id="loginPass" type="password" placeholder="Lozinka" required style="width:100%;margin-bottom:6px;">
          <button class="btn" style="width:100%;">Prijavi se</button>
          <div class="error" id="loginError"></div>
        </form>

        <!-- REGISTER -->
        <form id="registerForm" style="display:none;">
          <input id="regEmail" placeholder="Email" required style="width:100%;margin-bottom:6px;">
          <input id="regPass" type="password" placeholder="Lozinka (min 6)" required style="width:100%;margin-bottom:6px;">
          <button class="btn" style="width:100%;">Registriraj</button>
          <div class="error" id="regError"></div>
        </form>
      </div>

      <!-- Razredi -->
      <div class="card" id="gradesCard" style="display:none;margin-top:10px;">
        <h3 style="margin:0 0 8px;">Razredi</h3>
        <div class="grade-grid" id="gradeButtons">
          <button class="grade-btn" data-grade="1">1</button>
          <button class="grade-btn" data-grade="2">2</button>
          <button class="grade-btn" data-grade="3">3</button>
          <button class="grade-btn" data-grade="4">4</button>
          <button class="grade-btn" data-grade="5">5</button>
          <button class="grade-btn" data-grade="6">6</button>
          <button class="grade-btn" data-grade="7">7</button>
          <button class="grade-btn" data-grade="8">8</button>
          <button class="grade-btn" data-grade="9">9</button>
        </div>

        <button class="btn-ghost" id="btnMyBooks" style="margin-top:10px;width:100%;">Moje knjige</button>

        <div id="gradeStatus" style="font-size:12px;color:var(--muted);margin-top:6px;">
          Odaberi razred.
        </div>
      </div>
    </section>

    <!-- BOOKS -->
    <section class="card">
      <h2 id="booksTitle">Knjige</h2>
      <span id="booksSubtitle" style="font-size:12px;color:var(--muted);"></span>

      <div id="booksContainer" style="margin-top:10px;">
        <div style="padding:18px;text-align:center;color:var(--muted);">
          Prijavi se da vidiš knjige.
        </div>
      </div>
    </section>

  </div>
</main>

</div>

<script>
const state = {
  user:null,
  currentGrade:null,
  showingMyBooks:false
};

function formatPrice(s){
  s = s|0;
  if(s<=0) return "Besplatno";
  const g = Math.floor(s/100);
  const c = s%100;
  return c===0 ? g+" G" : g+" G "+c+" S";
}

/* HEADER */
function renderUserBox(){
  const box = document.getElementById("userBox");

  if(!state.user){
    box.innerHTML = `<div class="pill">Nisi prijavljen</div>`;
    return;
  }

  const saldoG = Math.floor(state.user.balance_silver/100);
  const saldoS = state.user.balance_silver%100;

  box.innerHTML = `
    <div class="pill"><strong>${state.user.email}</strong></div>
    <div class="pill">${saldoG} G / ${saldoS} S</div>

    ${state.user.is_admin ? `<a href="/admin" class="btn-ghost">Admin</a>` : ""}

    <button class="btn-ghost" id="btnLogout">Odjava</button>
  `;

  document.getElementById("btnLogout").onclick = async ()=>{
    await fetch("/api/logout");
    location.reload();
  };
}

/* PRIKAZ KNJIGA */
function renderBooksList(title, subtitle, books){
  const cont = document.getElementById("booksContainer");
  document.getElementById("booksTitle").textContent = title;
  document.getElementById("booksSubtitle").textContent = subtitle;

  if(!books || books.length===0){
    cont.innerHTML = `
      <div style="padding:18px;color:var(--muted);text-align:center;">
        Nema knjiga.
      </div>`;
    return;
  }

  cont.innerHTML = `
    <div class="books-grid">
      ${books.map(b=>{
        const img = "/slike/" + encodeURIComponent(b.name) + ".png";
        const owned = b.owned || b._owned;
        const free = (b.price_silver|0) === 0;

        return `
        <article class="book-card" data-id="${b.id}">
          ${owned ? `<span class="badge-owned">Kupljeno</span>` : ``}

          <div class="book-img"
               style="background-image:url('${img}');"
               onerror="this.style.background='linear-gradient(135deg,#22c55e,#16a34a)'">
          </div>

          <div style="flex:1;">
            <div class="book-title">${b.name}</div>
            <div class="book-author">${b.author || ""}</div>

            <div style="display:flex;justify-content:space-between;margin-top:4px;font-size:11px;">
              <span>Razred: ${b.grade}</span>
              <span class="price-tag ${free?'price-free':''}">${formatPrice(b.price_silver)}</span>
            </div>

            <div class="book-actions">
              ${owned
                ? `<button class="btn-outline btn-small" data-act="open">Otvori</button>`
                : `<button class="btn btn-small" data-act="buy">Kupi</button>`
              }
            </div>
          </div>
        </article>`;
      }).join("")}
    </div>
  `;

  cont.querySelectorAll(".book-card").forEach(card=>{
    card.addEventListener("click", async e=>{
      const act = e.target.closest("[data-act]")?.dataset.act;
      const id = parseInt(card.dataset.id);
      if(!id) return;

      if(act==="buy") buyBook(id);
      else if(act==="open") openBook(id);
    });
  });
}

/* KUPI KNJIGU */
async function buyBook(id){
  if(!state.user){ alert("Prvo se prijavi."); return; }

  const res = await fetch("/api/books/buy",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({book_id:id})
  });
  const data = await res.json();

  if(!data.ok){ alert(data.error); return; }

  state.user.balance_silver = data.balance_silver;
  renderUserBox();

  if(state.showingMyBooks) loadMyBooks();
  else loadBooks(state.currentGrade);
}

/* OTVORI */
async function openBook(id){
  const res = await fetch("/api/books/open/"+id);
  const data = await res.json();
  if(!data.ok){ alert(data.error); return; }
  window.open(data.pdf, "_blank");
}

/* LOADING */
async function loadBooks(grade){
  state.currentGrade = grade;
  state.showingMyBooks = false;

  const res = await fetch("/api/books/"+grade);
  const data = await res.json();
  renderBooksList("Knjige za razred "+grade,"",data.books||[]);
}

async function loadMyBooks(){
  state.showingMyBooks = true;

  const res = await fetch("/api/my/books");
  const data = await res.json();

  const list = (data.books||[]).map(b=>({...b,_owned:true}));
  renderBooksList("Moje knjige","Kupljene knjige",list);
}

/* AUTH + INIT */
document.querySelector("[data-tab='login']").onclick = ()=>{
  loginForm.style.display="block";
  registerForm.style.display="none";
};
document.querySelector("[data-tab='register']").onclick = ()=>{
  loginForm.style.display="none";
  registerForm.style.display="block";
};

loginForm.onsubmit = async e=>{
  e.preventDefault();
  const res = await fetch("/api/login",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({email:loginEmail.value,password:loginPass.value})
  });
  const data = await res.json();
  if(!data.ok){ loginError.textContent=data.error; return; }
  location.reload();
};

registerForm.onsubmit = async e=>{
  e.preventDefault();
  const res = await fetch("/api/register",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({email:regEmail.value,password:regPass.value})
  });
  const data = await res.json();
  if(!data.ok){ regError.textContent=data.error; return; }
  alert("Račun kreiran. Sada se prijavi.");
  location.reload();
};

/* INIT */
(async ()=>{
  const me = await fetch("/api/me").then(r=>r.json()).catch(()=>null);
  if(me && me.ok) state.user = me.user;

  renderUserBox();

  if(state.user){
    document.getElementById("authCard").style.display="none";
    document.getElementById("gradesCard").style.display="block";
  }
})();

</script>

</body>
</html>
