<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Online Knjižnica</title>

  <!-- POSEBAN CSS -->
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>

<!-- ========== LOGIN ========== -->
<div id="loginScreen" class="fullscreen">
  <div class="glass-box">
    <h2>Prijava</h2>
    <input id="loginEmail" class="input" placeholder="Email">
    <input id="loginPass" type="password" class="input" placeholder="Lozinka">
    <button id="btnLogin" class="btn">Prijavi se</button>
    <div id="loginError" style="color:red;margin-top:10px;text-align:center;"></div>

    <div id="goRegister"
         style="text-align:center;margin-top:12px;color:#22c55e;cursor:pointer;">
      Nemaš račun? Registruj se
    </div>
  </div>
</div>

<!-- ========== REGISTER ========== -->
<div id="registerScreen" class="fullscreen hidden">
  <div class="glass-box">
    <h2>Registracija</h2>
    <input id="regEmail" class="input" placeholder="Email">
    <input id="regPass" type="password" class="input" placeholder="Lozinka (min 6)">
    <button id="btnRegister" class="btn">Kreiraj račun</button>
    <div id="regError" style="color:red;margin-top:10px;text-align:center;"></div>

    <div id="goLogin"
         style="text-align:center;margin-top:12px;color:#22c55e;cursor:pointer;">
      Već imaš račun? Prijava
    </div>
  </div>
</div>

<!-- ========================================================= -->
<!--                      HEADER                               -->
<!-- ========================================================= -->
<div id="header" class="header hidden">
  <div class="header-left">
    <div id="headerEmail" class="header-title"></div>
  </div>

  <div class="header-right">
    <div class="pill"><strong id="headerGold">0</strong> G</div>
    <button id="btnLogout" class="btn-small btn-secondary">Odjava</button>
  </div>
</div>

<!-- ========================================================= -->
<!--                    APP CONTENT                            -->
<!-- ========================================================= -->
<div id="appContent" class="hidden" style="width:100%;">

  <!-- SIDEBAR – PC (vertical), MOBILE (horizontal scroll) -->
  <div class="sidebar" id="sidebar">
    <h2>Razredi</h2>

    <button class="grade-btn" data-grade="1">1. razred</button>
    <button class="grade-btn" data-grade="2">2. razred</button>
    <button class="grade-btn" data-grade="3">3. razred</button>
    <button class="grade-btn" data-grade="4">4. razred</button>
    <button class="grade-btn" data-grade="5">5. razred</button>
    <button class="grade-btn" data-grade="6">6. razred</button>
    <button class="grade-btn" data-grade="7">7. razred</button>
    <button class="grade-btn" data-grade="8">8. razred</button>
    <button class="grade-btn" data-grade="9">9. razred</button>

    <h2 style="margin-top:20px;">Srednja škola</h2>
    <button class="grade-btn" data-grade="1s">1. srednja</button>
    <button class="grade-btn" data-grade="2s">2. srednja</button>
    <button class="grade-btn" data-grade="3s">3. srednja</button>
    <button class="grade-btn" data-grade="4s">4. srednja</button>
    <button class="grade-btn" data-grade="knjige">knjige</button>
  </div>

  <!-- MAIN KNJIGE + DETALJI (PC layout) -->
  <div class="books-layout">

    <!-- LISTA KNJIGA -->
    <div>
      <h2 class="card-title">Odaberi razred</h2>
      <div id="booksGrid" class="books-grid"></div>
    </div>

    <!-- DETALJI (PC) -->
    <div id="detailsPanel" class="card">
      <h3>Detalji</h3>
      <div id="detailsContent">Odaberi knjigu.</div>
      <button id="btnBuy" class="btn-small" style="margin-top:10px;display:none;">Kupi</button>
      <button id="btnOpen" class="btn-small btn-secondary" style="margin-top:10px;display:none;">Otvori PDF</button>
    </div>

  </div>
</div>

<!-- ========================================================= -->
<!--              FULLSCREEN DETALJI (MOBILE)                  -->
<!-- ========================================================= -->
<div id="mobileDetails" class="fullscreen hidden" style="
     backdrop-filter: blur(18px);
     background: rgba(255,255,255,0.85);
     z-index:99999;
     padding:20px;">
  <div style="
      background:white;
      width:100%;
      max-width:420px;
      border-radius:18px;
      padding:20px;
      box-shadow:0 10px 35px rgba(0,0,0,0.25);">
    
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h3 id="mobTitle" style="margin:0;font-size:20px;"></h3>
      <div onclick="closeMobileDetails()"
           style="font-size:22px;cursor:pointer;padding:5px 10px;">×</div>
    </div>

    <div id="mobAuthor" style="margin-top:8px;color:#555;"></div>
    <div id="mobPrice" style="margin-top:8px;font-weight:bold;"></div>

    <button id="mobBuy" class="btn" style="margin-top:18px;display:none;">Kupi</button>
    <button id="mobOpen" class="btn-secondary" style="margin-top:10px;display:none;">Otvori PDF</button>
  </div>
</div>

<script>
/* ========================================================= */
/* LOGIN / REGISTER */
/* ========================================================= */
function showLogin(){
  loginScreen.classList.remove("hidden");
  registerScreen.classList.add("hidden");
  header.classList.add("hidden");
  appContent.classList.add("hidden");
}
function showRegister(){
  loginScreen.classList.add("hidden");
  registerScreen.classList.remove("hidden");
}
function showApp(){
  loginScreen.classList.add("hidden");
  registerScreen.classList.add("hidden");
  header.classList.remove("hidden");
  appContent.classList.remove("hidden");
}

goRegister.onclick = showRegister;
goLogin.onclick = showLogin;

async function checkMe(){
  try{
    const r = await fetch("/api/me");
    const j = await r.json();
    if(j.ok){
      headerEmail.textContent = j.user.email;
      headerGold.textContent = j.user.gold + " G";
      showApp();
    } else showLogin();
  } catch {
    showLogin();
  }
}
checkMe();

btnLogin.onclick = async ()=>{
  loginError.textContent="";
  const r = await fetch("/api/login",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      email:loginEmail.value.trim(),
      password:loginPass.value.trim()
    })
  });
  const j = await r.json();
  if(!j.ok) loginError.textContent = j.error || "Greška";
  else checkMe();
};

btnRegister.onclick = async ()=>{
  regError.textContent = "";
  const r = await fetch("/api/register",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      email:regEmail.value.trim(),
      password:regPass.value.trim()
    })
  });
  const j = await r.json();
  if(!j.ok) regError.textContent = j.error || "Greška";
  else {
    alert("Registracija uspješna!");
    showLogin();
  }
};

btnLogout.onclick = async ()=>{
  await fetch("/api/logout");
  showLogin();
};

/* ========================================================= */
/* BOOKS */
/* ========================================================= */
let currentGrade = null;
let selectedBook = null;

document.querySelectorAll(".grade-btn").forEach(btn=>{
  btn.onclick = ()=>{
    currentGrade = btn.dataset.grade;

    document.querySelectorAll(".grade-btn").forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');

    loadBooks(currentGrade);
  };
});

async function loadBooks(grade){
  booksGrid.innerHTML = "<p>Učitavam...</p>";

  const res = await fetch(`/api/books/${grade}`);
  const data = await res.json();
  if(!data.ok){
    booksGrid.innerHTML = "<p>Greška.</p>";
    return;
  }

  if(data.books.length === 0){
    booksGrid.innerHTML = "<p>Nema knjiga.</p>";
    return;
  }

  booksGrid.innerHTML = data.books.map(b=>{
    const img = b.cover_image || "/slike/default.jpg";
    return `
      <div class="book-card" data-id="${b.id}">
        <img src="${img}" style="width:100%;border-radius:12px;">
        <div class="book-title">${b.name}</div>
        <div class="book-grade">${b.author}</div>
        <div class="book-price">
          ${b.price_silver==0 ? "Besplatno" : Math.floor(b.price_silver/100)+" G"}
        </div>
      </div>
    `;
  }).join("");

  document.querySelectorAll(".book-card").forEach(c=>{
    c.onclick = ()=> openDetails(c.dataset.id);
  });
}

/* ========================================================= */
/* DETAILS (PC + MOBILE) */
/* ========================================================= */

async function openDetails(id){
  selectedBook=id;

  const res = await fetch(`/api/books/${currentGrade}`);
  const data = await res.json();
  if(!data.ok) return;

  const b = data.books.find(x=>x.id == id);
  if(!b) return;

  // PC PANEL
  detailsContent.innerHTML = `
    <h3>${b.name}</h3>
    <p><b>Autor:</b> ${b.author}</p>
    <p><b>Cijena:</b> ${b.price_silver==0?"Besplatno":Math.floor(b.price_silver/100)+" G"}</p>
  `;
  btnBuy.style.display  = b.owned ? "none" : "block";
  btnOpen.style.display = b.owned ? "block" : "none";

  // MOBILE FULLSCREEN
  mobTitle.textContent = b.name;
  mobAuthor.textContent = "Autor: " + b.author;
  mobPrice.textContent  = b.price_silver==0 ? "Besplatno" :
                          Math.floor(b.price_silver/100)+" G";

  mobBuy.style.display  = b.owned ? "none" : "block";
  mobOpen.style.display = b.owned ? "block" : "none";

  // SHOW fullscreen only if screen < 800px
  if(window.innerWidth < 800){
    mobileDetails.classList.remove("hidden");
  }
}

function closeMobileDetails(){
  mobileDetails.classList.add("hidden");
}

/* BUY */
btnBuy.onclick = mobBuy.onclick = async ()=>{
  const r = await fetch("/api/books/buy",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ book_id:selectedBook })
  });
  const j = await r.json();
  if(j.ok){
    await checkMe();
    openDetails(selectedBook);
  } else alert(j.error);
};

/* OPEN PDF */
btnOpen.onclick = mobOpen.onclick = async ()=>{
  const r = await fetch(`/api/books/open/${selectedBook}`);
  const j = await r.json();
  if(j.ok) window.open(j.pdf,"_blank");
};

</script>
</body>
</html>
