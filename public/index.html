<!DOCTYPE html>
<html lang="hr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Online Knjižnica</title>

<link rel="stylesheet" href="/app.css">
</head>

<body>

<!-- LOGIN -->
<div id="loginScreen" class="fullscreen">
  <div class="glass-box">
    <h2>Prijava</h2>

    <input id="loginEmail" class="input" placeholder="Email">
    <input id="loginPass" type="password" class="input" placeholder="Lozinka">

    <button id="btnLogin" class="btn btn-accent">Prijavi se</button>
    <div id="loginError" class="error-text"></div>

    <div id="goRegister" class="link">Nemaš račun? Registruj se</div>
  </div>
</div>

<!-- REGISTER -->
<div id="registerScreen" class="fullscreen hidden">
  <div class="glass-box">
    <h2>Registracija</h2>

    <input id="regEmail" class="input" placeholder="Email">
    <input id="regPass" type="password" class="input" placeholder="Lozinka (min 6)">

    <button id="btnRegister" class="btn btn-accent">Kreiraj račun</button>
    <div id="regError" class="error-text"></div>

    <div id="goLogin" class="link">Već imaš račun? Prijava</div>
  </div>
</div>

<!-- HEADER -->
<div id="header" class="header hidden">
  <div id="headerEmail" class="header-user"></div>
  <div id="headerGold" class="header-gold"></div>
  <div id="btnLogout" class="logout">Odjava</div>
</div>


<!-- APP CONTENT -->
<div id="appContent" class="hidden app-wrapper">

  <!-- SIDEBAR -->
  <div class="sidebar">

    <h2>Razredi</h2>
    <button class="grade-btn" data-grade="1">1. razred</button>
    <button class="grade-btn" data-grade="2">2. razred</button>
    <button class="grade-btn" data-grade="3">3. razred</button>
    <button class="grade-btn" data-grade="4">4. razred</button>
    <button class="grade-btn" data-grade="5">5. razred</button>
    <button class="grade-btn" data-grade="6">6. razred</button>
    <button class="grade-btn" data-grade="7">7. razred</button>
    <button class="grade-btn" data-grade="8">8. razred</button>
    <button class="grade-btn" data-grade="9">9. razred</button>

    <h2 style="margin-top:20px;">Srednja škola</h2>
    <button class="grade-btn" data-grade="1s">1. srednja</button>
    <button class="grade-btn" data-grade="2s">2. srednja</button>
    <button class="grade-btn" data-grade="3s">3. srednja</button>
    <button class="grade-btn" data-grade="4s">4. srednja</button>
    <button class="grade-btn" data-grade="knjige">knjige</button>
  </div>


  <!-- MAIN -->
  <div class="main">

    <!-- BOOK LIST -->
    <div class="books-panel">
      <div class="books-title" id="booksTitle">Odaberi razred</div>
      <div id="booksContainer">—</div>
    </div>

    <!-- DETAILS -->
    <div class="details-panel">

      <h3>Detalji</h3>
      <div id="detailsContent">Odaberi knjigu.</div>

      <button id="btnBuy" class="btn btn-accent" style="display:none;">Kupi</button>
      <button id="btnOpen" class="btn btn-outline" style="display:none;">Otvori PDF</button>

    </div>

  </div>
</div>


<script>
// -------------------------------- LOGIN --------------------------------

function showLogin(){
  loginScreen.classList.remove("hidden");
  registerScreen.classList.add("hidden");
  header.classList.add("hidden");
  appContent.classList.add("hidden");
}

function showRegister(){
  loginScreen.classList.add("hidden");
  registerScreen.classList.remove("hidden");
}

function showApp(){
  loginScreen.classList.add("hidden");
  registerScreen.classList.add("hidden");
  header.classList.remove("hidden");
  appContent.classList.remove("hidden");
}

goRegister.onclick = showRegister;
goLogin.onclick = showLogin;


// CHECK SESSION
async function checkMe(){
  try{
    const r = await fetch("/api/me");
    const j = await r.json();

    if(j.ok){
      headerEmail.textContent = j.user.email;
      headerGold.textContent = j.user.gold + " G";
      showApp();
    } else showLogin();

  }catch{
    showLogin();
  }
}

checkMe();


// LOGIN
btnLogin.onclick = async ()=>{
  loginError.textContent = "";

  const email = loginEmail.value.trim();
  const pass  = loginPass.value.trim();

  const r = await fetch("/api/login",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ email, password:pass })
  });

  const j = await r.json();
  if(!j.ok){
    loginError.textContent = j.error || "Greška";
  } else {
    checkMe();
  }
};


// REGISTER
btnRegister.onclick = async ()=>{
  regError.textContent = "";

  const email = regEmail.value.trim();
  const pass  = regPass.value.trim();

  const r = await fetch("/api/register",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ email, password:pass })
  });

  const j = await r.json();

  if(!j.ok){
    regError.textContent = j.error || "Greška";
  } else {
    alert("Registracija uspješna!");
    showLogin();
  }
};


// LOGOUT
btnLogout.onclick = async ()=>{
  await fetch("/api/logout");
  showLogin();
};



// -------------------------------- BOOKS --------------------------------

let currentGrade = null;
let selectedBook = null;

document.querySelectorAll(".grade-btn").forEach(btn => {
  btn.onclick = ()=>{
    currentGrade = btn.dataset.grade;

    document.querySelectorAll(".grade-btn").forEach(x=>x.classList.remove("active"));
    btn.classList.add("active");

    loadBooks(currentGrade);
  };
});


// LOAD
async function loadBooks(grade){
  booksTitle.textContent = "Učitavam...";

  const res = await fetch(`/api/books/${grade}`);
  const data = await res.json();

  if(!data.ok){
    booksContainer.innerHTML = "<p>Greška.</p>";
    return;
  }

  booksTitle.textContent = `Knjige za ${grade}`;

  if(data.books.length === 0){
    booksContainer.innerHTML = "<p>Nema knjiga.</p>";
    return;
  }

  booksContainer.innerHTML = data.books.map(b=>{
    const img = b.cover_image || "/slike/default.jpg";

    return `
      <div class="book-card" data-id="${b.id}">
        <div class="book-img" style="background-image:url('${img}')"></div>

        <div class="book-info">
          <div>
            <div class="book-title">${b.name}</div>
            <div class="book-author">${b.author}</div>
          </div>
          <div style="font-weight:600;opacity:.7;">
            ${b.price_silver==0 ? "Besplatno" : Math.floor(b.price_silver/100) + " G"}
          </div>
        </div>
      </div>
    `;
  }).join("");

  document.querySelectorAll(".book-card").forEach(c=>{
    c.onclick = () => openDetails(c.dataset.id);
  });
}


// DETAILS
async function openDetails(id){
  selectedBook = id;

  const res = await fetch(`/api/books/${currentGrade}`);
  const data = await res.json();

  const b = data.books.find(x=>x.id == id);
  if(!b) return;

  detailsContent.innerHTML = `
    <h3>${b.name}</h3>
    <p><b>Autor:</b> ${b.author}</p>
    <p><b>Cijena:</b> ${b.price_silver==0 ? "Besplatno" : Math.floor(b.price_silver/100) + " G"}</p>
  `;

  btnBuy.style.display  = b.owned ? "none" : "block";
  btnOpen.style.display = b.owned ? "block" : "none";
}


// BUY
btnBuy.onclick = async ()=>{
  const r = await fetch("/api/books/buy",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ book_id:selectedBook })
  });

  const j = await r.json();
  if(j.ok){
    await checkMe();
    openDetails(selectedBook);
  } else {
    alert(j.error);
  }
};


// OPEN PDF
btnOpen.onclick = async ()=>{
  const r = await fetch(`/api/books/open/${selectedBook}`);
  const j = await r.json();

  if(j.ok){
    window.open(j.pdf,"_blank");
  }
};

</script>

</body>
</html>
