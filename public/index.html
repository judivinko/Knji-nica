<!doctype html>
<html lang="hr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Online Knjižnica</title>

  <style>
    :root{
      --bg:#020617;
      --accent:#22c55e;
      --accent-soft:rgba(34,197,94,0.15);
      --danger:#ef4444;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border:#1f2937;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#020617;
      color:var(--text);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:16px;}

    header{
      display:flex;justify-content:space-between;align-items:center;
      background:#030a1a;border:1px solid var(--border);
      padding:10px 14px;border-radius:14px;margin-bottom:16px;
    }
    .btn{padding:6px 12px;border-radius:999px;background:var(--accent);
      color:#022c22;font-size:12px;font-weight:600;cursor:pointer;border:none;}
    .btn-ghost{padding:6px 12px;border-radius:999px;background:transparent;
      border:1px solid var(--border);color:var(--muted);font-size:12px;cursor:pointer;}
    .grade-btn{
      padding:6px 10px;border-radius:999px;background:#0f172a;border:1px solid #1e293b;
      color:var(--muted);cursor:pointer;font-size:12px;
    }
    .grade-btn.active{background:var(--accent-soft);color:var(--accent);border-color:var(--accent);}
    .book-card{
      background:#0f172a;border:1px solid #1f2937;padding:10px;border-radius:12px;
      display:flex;gap:10px;
    }
    .book-img{width:80px;height:110px;border-radius:8px;object-fit:cover;}
    .badge-owned{background:rgba(34,197,94,0.22);color:var(--accent);
      padding:2px 6px;border-radius:999px;font-size:10px;margin-bottom:3px;display:inline-block;}
  </style>

  <!-- PayPal SDK auto-loaded via JS -->
  <script id="paypalSDK"></script>
</head>
<body>
  <div class="wrap">

    <!-- HEADER -->
    <header>
      <div style="font-size:17px;font-weight:600;">Online Knjižnica</div>
      <div id="userBox"></div>
    </header>

    <!-- AUTH -->
    <div id="authBox" style="margin-bottom:16px;">
      <div>
        <input id="email" placeholder="Email" style="padding:6px 8px;width:180px;border-radius:6px;border:1px solid #1e293b;background:#0f172a;color:white;">
        <input id="pass" type="password" placeholder="Lozinka" style="padding:6px 8px;width:150px;border-radius:6px;border:1px solid #1e293b;background:#0f172a;color:white;">
        <button class="btn" onclick="login()">Prijava</button>
        <button class="btn-ghost" onclick="registerUser()">Registracija</button>
      </div>
      <div id="authError" style="color:var(--danger);font-size:12px;margin-top:4px;"></div>
    </div>

    <!-- RAZREDI -->
    <div id="gradesBox" style="display:none;margin-bottom:16px;flex-wrap:wrap;gap:6px;">
      <script>
        const grades = ["1","2","3","4","5","6","7","8","9","1s","2s","3s","4s","ostalo"];
      </script>
      <div id="grades"></div>
    </div>

    <!-- KNJIGE -->
    <h2 id="booksTitle" style="margin-bottom:10px;">Knjige</h2>
    <div id="booksContainer"></div>

  </div>


<script>
let state={user:null, grade:null};

/* ---------------------- AUTH ---------------------- */
async function fetchMe(){
  try{
    let r=await fetch("/api/me");
    let d=await r.json();
    state.user=d.ok?d.user:null;
  }catch{ state.user=null; }
  renderUser();
}

async function login(){
  const email=document.getElementById("email").value.trim();
  const pass=document.getElementById("pass").value.trim();
  const out=document.getElementById("authError");
  out.textContent="";
  try{
    let r=await fetch("/api/login",{
      method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({email,password:pass})
    });
    let d=await r.json();
    if(!d.ok){ out.textContent=d.error;return; }
    await fetchMe();
  }catch{ out.textContent="Greška."; }
}

async function registerUser(){
  const email=document.getElementById("email").value.trim();
  const pass=document.getElementById("pass").value.trim();
  const out=document.getElementById("authError");
  out.textContent="";
  try{
    let r=await fetch("/api/register",{
      method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({email,password:pass})
    });
    let d=await r.json();
    if(!d.ok){ out.textContent=d.error;return; }
    out.textContent="Račun kreiran. Prijavi se.";
  }catch{ out.textContent="Greška."; }
}

async function logout(){
  await fetch("/api/logout");
  state.user=null;
  state.grade=null;
  renderUser();
}

/* ---------------------- UI ---------------------- */
function renderUser(){
  const box=document.getElementById("userBox");
  const authBox=document.getElementById("authBox");
  const grades=document.getElementById("gradesBox");

  if(!state.user){
    box.innerHTML=`<span style="color:var(--muted)">Niste prijavljeni</span>`;
    authBox.style.display="block";
    grades.style.display="none";
    document.getElementById("booksContainer").innerHTML="";
    return;
  }

  const g=Math.floor(state.user.balance_silver/100);
  const s=state.user.balance_silver%100;

  box.innerHTML=`
    <span style="margin-right:10px;">${state.user.email}</span>
    <span style="margin-right:10px;">${g}G / ${s}S</span>
    <button class="btn-ghost" onclick="openPay()">Kupi silver</button>
    ${state.user.is_admin ? `<a class="btn-ghost" href="/admin">Admin</a>` : ""}
    <button class="btn-ghost" onclick="logout()">Odjava</button>
  `;

  authBox.style.display="none";
  grades.style.display="flex";
  showGradeButtons();
}

function showGradeButtons(){
  let html="";
  grades.forEach(g=>{
    html+=`<button class="grade-btn" onclick="loadGrade('${g}')">${g}</button>`;
  });
  document.getElementById("grades").innerHTML=html;
}

/* ---------------------- LOAD BOOKS ---------------------- */
async function loadGrade(g){
  state.grade=g;
  let r=await fetch("/api/books/"+g);
  let d=await r.json();
  if(!d.ok){ alert("Greška."); return; }
  renderBooks(d.books);
}

function renderBooks(list){
  const box=document.getElementById("booksContainer");
  if(list.length===0){
    box.innerHTML=`<div style="color:var(--muted);">Nema knjiga.</div>`;
    return;
  }
  let html="";
  list.forEach(b=>{
    const img=`/slike/${b.name}.png`;
    const owned=b.owned?`<div class="badge-owned">Kupljeno</div>`:"";
    const price=b.price_silver<=0 ? "Besplatno" : formatPrice(b.price_silver);
    html += `
      <div class="book-card" data-id="${b.id}">
        <img src="${img}" class="book-img" onerror="this.src='/slike/default.png'">
        <div style="flex:1;">
          ${owned}
          <div style="font-size:14px;font-weight:600;">${b.name}</div>
          <div style="font-size:12px;color:var(--muted);">Razred: ${b.grade}</div>
          <div style="margin-top:6px;font-size:13px;">${price}</div>

          ${
            b.owned
            ? `<button class="btn-ghost" onclick="openBook(${b.id})">Otvori</button>`
            : `<button class="btn" onclick="buyBook(${b.id})">Kupi</button>`
          }
        </div>
      </div>
      <br>
    `;
  });
  box.innerHTML=html;
}

function formatPrice(s){
  s|=0;
  if(s<=0) return "Besplatno";
  const g=Math.floor(s/100), c=s%100;
  return c===0?`${g} G`:`${g} G ${c} S`;
}

/* ---------------------- BUY / OPEN ---------------------- */
async function buyBook(id){
  let r=await fetch("/api/books/buy",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({book_id:id})
  });
  let d=await r.json();
  if(!d.ok){ alert(d.error); return; }
  await fetchMe();
  loadGrade(state.grade);
}

async function openBook(id){
  let r=await fetch("/api/books/open/"+id);
  let d=await r.json();
  if(!d.ok){ alert(d.error); return; }
  window.open(d.pdf,"_blank");
}

/* ---------------------- PAYPAL ---------------------- */
function openPay(){
  let usd=prompt("Unesi iznos u USD (min 1):","");
  if(!usd) return;
  usd=Number(usd);
  if(usd<1){ alert("Minimalno $1"); return; }
  createPayOrder(usd);
}

async function createPayOrder(amount){
  const cfg = await (await fetch("/api/paypal/config")).json();
  if(!cfg.ok){ alert("PayPal nije konfiguriran."); return; }

  document.getElementById("paypalSDK").src =
    `https://www.paypal.com/sdk/js?client-id=${cfg.client_id}&currency=USD`;

  paypal.Buttons({
    createOrder: async ()=>{
      let r=await fetch("/api/paypal/create-order",{
        method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({amount_usd:amount})
      });
      let d=await r.json();
      return d.id;
    },
    onApprove: async (data)=>{
      let r=await fetch("/api/paypal/confirm",{
        method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({orderId:data.orderID})
      });
      let d=await r.json();
      if(!d.ok){ alert("Greška pri potvrdi."); return; }
      await fetchMe();
      alert("Uspješno uplaćeno!");
    }
  }).render("body");
}

/* ---------------------- INIT ---------------------- */
fetchMe();
</script>

</body>
</html>
