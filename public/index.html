<!DOCTYPE html>
<html lang="hr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Online Knjižnica</title>

<style>
/* ------------------- iOS Premium Design ------------------- */
:root{
  --bg:#f5f5f7;
  --panel:#ffffff;
  --accent:#007aff;
  --text:#1c1c1e;
  --muted:#8e8e93;
  --radius:16px;
  --shadow:0 8px 25px rgba(0,0,0,0.12);
}

body{
  margin:0;
  background:var(--bg);
  font-family:-apple-system, BlinkMacSystemFont, "SF Pro", "Segoe UI", Roboto, sans-serif;
  color:var(--text);
  height:100vh;
  display:flex;
}

.sidebar{
  width:260px;
  padding:20px;
  background:#ffffffcc;
  backdrop-filter:blur(30px);
  box-shadow:2px 0 25px rgba(0,0,0,0.1);
  display:flex;
  flex-direction:column;
  gap:10px;
}

.sidebar h2{
  margin:0 0 10px;
  font-size:22px;
  font-weight:700;
}

.grade-btn{
  padding:12px 16px;
  background:#fff;
  border-radius:var(--radius);
  border:1px solid #e0e0e5;
  font-size:16px;
  font-weight:600;
  cursor:pointer;
  transition:.15s;
  text-align:left;
}

.grade-btn:hover{
  background:#f0f0f5;
}

.grade-btn.active{
  background:var(--accent);
  color:#fff;
  border-color:var(--accent);
}

.main{
  flex:1;
  display:flex;
  gap:20px;
  padding:20px;
  overflow:hidden;
}

/* Books grid */
.books-panel{
  flex:2;
  background:var(--panel);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:20px;
  overflow-y:auto;
}

.books-title{
  font-size:24px;
  font-weight:700;
  margin-bottom:20px;
}

/* iOS card */
.book-card{
  background:#fff;
  border-radius:var(--radius);
  padding:16px;
  display:flex;
  gap:16px;
  box-shadow:var(--shadow);
  cursor:pointer;
  transition:.2s;
}

.book-card:hover{
  transform:translateY(-3px);
}

.book-img{
  width:90px;
  height:120px;
  background:#ddd;
  border-radius:var(--radius);
  background-size:cover;
  background-position:center;
}

.book-info{
  flex:1;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
}

.book-title{
  font-size:18px;
  font-weight:700;
}

.book-author{
  color:var(--muted);
  font-size:14px;
}

/* Right panel */
.details-panel{
  flex:1.2;
  background:#ffffffcc;
  border-radius:var(--radius);
  backdrop-filter:blur(20px);
  box-shadow:var(--shadow);
  padding:20px;
  display:flex;
  flex-direction:column;
  gap:14px;
}

.details-panel h3{
  margin:0;
  font-size:22px;
}

.btn{
  padding:12px 18px;
  border-radius:var(--radius);
  border:none;
  cursor:pointer;
  font-size:16px;
  font-weight:600;
}

.btn-accent{
  background:var(--accent);
  color:#fff;
}

.btn-outline{
  background:#fff;
  border:2px solid var(--accent);
  color:var(--accent);
}

/* Scrollbars hidden */
.books-panel::-webkit-scrollbar,
.details-panel::-webkit-scrollbar{
  width:0;
}
</style>
</head>

<body>

<!-- ---------------- Sidebar (Razredi) ---------------- -->
<div class="sidebar" id="sidebar">
  <h2>Razredi</h2>

  <button class="grade-btn" data-grade="1">1. razred</button>
  <button class="grade-btn" data-grade="2">2. razred</button>
  <button class="grade-btn" data-grade="3">3. razred</button>
  <button class="grade-btn" data-grade="4">4. razred</button>
  <button class="grade-btn" data-grade="5">5. razred</button>
  <button class="grade-btn" data-grade="6">6. razred</button>
  <button class="grade-btn" data-grade="7">7. razred</button>
  <button class="grade-btn" data-grade="8">8. razred</button>
  <button class="grade-btn" data-grade="9">9. razred</button>

  <h2 style="margin-top:20px;">Srednja</h2>
  <button class="grade-btn" data-grade="1s">1. srednja</button>
  <button class="grade-btn" data-grade="2s">2. srednja</button>
  <button class="grade-btn" data-grade="3s">3. srednja</button>
  <button class="grade-btn" data-grade="4s">4. srednja</button>
</div>

<!-- ---------------- Sredina + Desno ---------------- -->
<div class="main">

  <!-- SREDINA – KNJIGE -->
  <div class="books-panel">
    <div class="books-title" id="booksTitle">Odaberi razred</div>
    <div id="booksContainer">—</div>
  </div>

  <!-- DESNO – DETALJI KNJIGE + PayPal -->
  <div class="details-panel" id="detailsPanel">
    <h3>Detalji</h3>
    <div id="detailsContent">Odaberi knjigu.</div>

    <button id="btnBuy" class="btn btn-accent" style="display:none;">Kupi</button>
    <button id="btnOpen" class="btn btn-outline" style="display:none;">Otvori PDF</button>

    <hr style="margin:10px 0;">
    <h3>PayPal</h3>
    <div id="paypal-button-container"></div>
  </div>

</div>



<!-- ---------------- JAVASCRIPT ---------------- -->
<script>
// GLOBAL STATE
let currentGrade = null;
let selectedBook = null;

// Sidebar click → load grade books
document.querySelectorAll(".grade-btn").forEach(btn=>{
  btn.onclick = ()=>{
    currentGrade = btn.dataset.grade;

    document.querySelectorAll(".grade-btn").forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');

    loadBooks(currentGrade);
  };
});

async function loadBooks(grade){
  document.getElementById("booksTitle").textContent = "Učitavam...";
  const box = document.getElementById("booksContainer");

  try{
    const res = await fetch(`/api/books/${grade}`);
    const data = await res.json();

    if(!data.ok) throw 0;

    document.getElementById("booksTitle").textContent = `Knjige za ${grade}. razred`;

    if(data.books.length===0){
      box.innerHTML = "<p>Nema knjiga.</p>";
      return;
    }

    box.innerHTML = data.books.map(b=>{
      const img = b.img ? `/slike/${b.img}` : `/slike/default.png`;
      return `
      <div class="book-card" data-id="${b.id}">
        <div class="book-img" style="background-image:url('${img}')"></div>
        <div class="book-info">
          <div>
            <div class="book-title">${b.name}</div>
            <div class="book-author">${b.author||""}</div>
          </div>
          <div style="font-weight:600;opacity:.7;">${b.price_silver==0?"Besplatno":Math.floor(b.price_silver/100)+" G"}</div>
        </div>
      </div>`;
    }).join("");

    document.querySelectorAll(".book-card").forEach(c=>{
      c.onclick = ()=> openDetails(c.dataset.id);
    });

  }catch{
    box.innerHTML="<p>Greška.</p>";
  }
}

async function openDetails(id){
  selectedBook=id;

  const res = await fetch(`/api/books/info/${id}`);
  const data = await res.json();

  const panel = document.getElementById("detailsContent");
  panel.innerHTML = `
    <h3>${data.book.name}</h3>
    <p><b>Autor:</b> ${data.book.author}</p>
    <p><b>Cijena:</b> ${data.book.price_silver==0?"Besplatno":Math.floor(data.book.price_silver/100)+" G"}</p>
  `;

  document.getElementById("btnBuy").style.display = data.book.owned? "none":"block";
  document.getElementById("btnOpen").style.display = data.book.owned? "block":"none";
}

// Kupi
document.getElementById("btnBuy").onclick = async ()=>{
  const res = await fetch("/api/books/buy",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ book_id:selectedBook })
  });
  const data = await res.json();
  if(data.ok){
    openDetails(selectedBook);
  }else{
    alert(data.error || "Greška");
  }
};

// Otvori PDF
document.getElementById("btnOpen").onclick = async ()=>{
  const res = await fetch(`/api/books/open/${selectedBook}`);
  const data = await res.json();
  if(data.ok && data.pdf){
    window.open(data.pdf,"_blank");
  }
};
</script>

<!-- ---------------- PAYPAL (iz Artefakta) ---------------- -->
<script>
(async function loadPayPalSDK(){
  try{
    const r = await fetch("/api/paypal/config", { credentials:"include" });
    const j = await r.json();
    if(!j.ok || !j.client_id){ return; }
    const qs=new URLSearchParams({"client-id":j.client_id,"currency":j.currency||"USD","intent":"capture","components":"buttons"});
    const s=document.createElement("script");
    s.src=`https://www.paypal.com/sdk/js?${qs.toString()}`;
    s.async=true;
    s.onload=()=>{
      paypal.Buttons({
        createOrder:(d,a)=>a.order.create({purchase_units:[{amount:{value:"1.00"}}]}),
        onApprove:async (d,a)=>{await a.order.capture();alert("Hvala!");}
      }).render("#paypal-button-container");
    };
    document.head.appendChild(s);
  }catch{}
})();
</script>

</body>
</html>
